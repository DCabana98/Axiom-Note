<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axiom Note - v4.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f9; --container-bg-color: #ffffff; --text-color: #333;
            --header-color: #2c3e50; --label-color: #34495e; --border-color: #ccc;
            --input-bg-color: #ffffff; --result-bg-color: #f9fafb; --shadow-color: rgba(0, 0, 0, 0.08);
            --utility-btn-bg: #ecf0f1; --utility-btn-text: #2c3e50; --utility-btn-border: #bdc3c7;
        }
        body.dark-mode {
            --bg-color: #131314; --container-bg-color: #1e1f20; --text-color: #e3e3e3;
            --header-color: #ffffff; --label-color: #bdc1c6; --border-color: #444746;
            --input-bg-color: #303134; --result-bg-color: #282a2c; --shadow-color: rgba(0, 0, 0, 0.3);
            --utility-btn-bg: #303134; --utility-btn-text: #e3e3e3; --utility-btn-border: #444746;
        }
        body { font-family: "Times New Roman", Times, serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--container-bg-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); position: relative; transition: background-color 0.3s; }
        .top-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 0.9em; margin-bottom: 0; color: var(--label-color); }
        .control-group select {
            background-color: var(--input-bg-color); color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 4px 8px; font-family: inherit;
        }
        h1 { text-align: center; color: var(--header-color); margin-top: 60px; margin-bottom: 30px; font-size: 2em; text-transform: uppercase; }
        .form-section { border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .datos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .pattern-group { margin-bottom: 25px; position: relative; }
        h3 { color: var(--label-color); border-bottom: 2px solid var(--utility-btn-bg); padding-bottom: 10px; margin-top: 30px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--label-color); }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1em; font-family: inherit; background-color: var(--input-bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        #generate-btn { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        #generate-btn:disabled { background: #5f6368; cursor: not-allowed; }
        .result-container { margin-top: 40px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 20px; }
        h2 { color: var(--header-color); margin: 0; }
        .utility-btn { padding: 8px 12px; font-size: 0.9em; background-color: var(--utility-btn-bg); color: var(--utility-btn-text); border: 1px solid var(--utility-btn-border); border-radius: 6px; cursor: pointer; }
        .hidden { display: none; }
        #result-text { min-height: 250px; }
        #recommendations-text { min-height: 150px; }
        #keywords-text { min-height: 80px; }
        .export-section { margin-top: 30px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #export-pdf-btn { font-weight: bold; }
        .word-counter {
            position: absolute; bottom: 12px; right: 15px; font-size: 0.75em;
            color: var(--label-color); background-color: var(--input-bg-color); padding: 2px 6px;
            border-radius: 4px; opacity: 0.7; pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="control-group">
                <label for="theme-select">Tema:</label>
                <select id="theme-select">
                    <option value="light">Claro</option>
                    <option value="dark">Oscuro</option>
                </select>
            </div>
        </div>

        <h1>Axiom Note</h1>
        <form id="note-form">
            <div class="form-section">
                <label for="contexto-informe">Contexto del Informe</label>
                <select id="contexto-informe">
                    <option value="urgencias">Urgencias</option>
                    <option value="planta">Ingreso en Planta</option>
                    <option value="evolutivo">Evolutivo de planta</option>
                </select>
            </div>
            
            <div id="urgencias-fields" class="hidden">
                <div class="form-section datos-grid">
                    <div><label for="urg-fecha-hora">Fecha y Hora de Llegada</label><input type="text" id="urg-fecha-hora"></div>
                    <div><label for="urg-nombre">Nombre</label><input type="text" id="urg-nombre"></div>
                    <div><label for="urg-edad">Edad</label><input type="number" id="urg-edad"></div>
                    <div><label for="urg-sexo">Sexo</label><select id="urg-sexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                    <div id="urg-embarazo-container" class="hidden"><label for="urg-embarazo">Embarazo</label><select id="urg-embarazo"><option value="No">No</option><option value="Sí">Sí</option><option value="No sabe">No sabe</option></select></div>
                    <div><label for="urg-alergias">Alergias</label><input type="text" id="urg-alergias" placeholder="Ej: Penicilina..."></div>
                </div>
                <div class="pattern-group"><label for="urg-motivo">Motivo de Consulta</label><textarea id="urg-motivo" placeholder="Dolor torácico opresivo..."></textarea></div>
                <div class="pattern-group"><label for="urg-triaje">Constantes y Nivel de Triaje</label><textarea id="urg-triaje" placeholder="TA 150/90, FC 110 lpm, SatO2 96%, Nivel II..."></textarea></div>
                <div class="pattern-group"><label for="urg-historia">Historia Actual</label><textarea id="urg-historia" placeholder="Inicio de síntomas, evolución..."></textarea></div>
                <div class="pattern-group"><label for="urg-antecedentes">Antecedentes Relevantes</label><textarea id="urg-antecedentes" placeholder="Medicación crónica, tóxicos..."></textarea></div>
                <div class="pattern-group"><label for="urg-exploracion">Exploración Física</label><textarea id="urg-exploracion" placeholder="Auscultación, palpación, estado neurológico..."></textarea></div>
                <div class="pattern-group"><label for="urg-pruebas">Pruebas Realizadas en Urgencias</label><textarea id="urg-pruebas" placeholder="Resultados de ECG, analítica, test rápidos..."></textarea></div>
                <div class="pattern-group"><label for="urg-sospecha">Sospecha Diagnóstica</label><textarea id="urg-sospecha" placeholder="Ej: Síndrome Coronario Agudo..."></textarea></div>
                <div class="pattern-group"><label for="urg-plan">Plan Inmediato y Tratamiento</label><textarea id="urg-plan" placeholder="Ej: Se administra AAS, se solicita analítica..."></textarea></div>
            </div>
            <div id="planta-fields" class="hidden">
                 <h3>Información Inicial</h3>
                 <div class="form-section datos-grid">
                    <div><label for="planta-nombre">Nombre del Paciente</label><input type="text" id="planta-nombre"></div>
                    <div><label for="planta-edad">Edad</label><input type="number" id="planta-edad"></div>
                    <div><label for="planta-sexo">Sexo</label><select id="planta-sexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                 </div>
                 <h3>Bloque 1: Contexto del Paciente</h3>
                 <div class="pattern-group"><label for="planta-motivo_ingreso">Motivo de Ingreso</label><textarea id="planta-motivo_ingreso" placeholder="Ej: Ingresa desde Urgencias por insuficiencia cardíaca descompensada."></textarea></div>
                 <div class="pattern-group"><label for="planta-alergias">Alergias</label><textarea id="planta-alergias" placeholder="Ej: Penicilina, AINEs, Contrastes Yodados..."></textarea></div>
                 <div class="pattern-group"><label for="planta-antecedentes">Antecedentes Personales</label><textarea id="planta-antecedentes" placeholder="Ej: HTA, DM2 en tto con Metformina, apendicectomía en la infancia."></textarea></div>
                 <h3>Bloque 2: Evaluación Clínica</h3>
                 <div class="pattern-group"><label for="planta-exploracion">Exploración Física</label><textarea id="planta-exploracion" placeholder="Ej: Consciente y orientado. Eupneico. ACR: Tonos rítmicos. AP: Crepitantes en bases. EEII: Edemas con fóvea."></textarea></div>
                 <div class="pattern-group"><label for="planta-pruebas">Resultados de Pruebas Complementarias</label><textarea id="planta-pruebas" placeholder="Ej: Analítica: Leucocitos normales, PCR 45, Pro-BNP elevado. Rx Tórax: Signos de congestión pulmonar."></textarea></div>
                 <h3>Bloque 3: Plan de Actuación</h3>
                 <div class="pattern-group"><label for="planta-tratamiento">Plan de Tratamiento Inicial</label><textarea id="planta-tratamiento" placeholder="Ej: Se inicia tratamiento con diuréticos IV (Furosemida), oxigenoterapia."></textarea></div>
                 <div class="pattern-group"><label for="planta-cuidados">Plan de Cuidados de Enfermería</label><textarea id="planta-cuidados" placeholder="Ej: Monitorización de constantes cada 8h, control de diuresis y balance hídrico, dieta hiposódica."></textarea></div>
                 <div class="pattern-group"><label for="planta-intervenciones">Justificación de Intervenciones</label><textarea id="planta-intervenciones" placeholder="Ej: Se canaliza VVP para sueroterapia. Profilaxis tromboembólica con heparina."></textarea></div>
            </div>
            <div id="evolutivo-fields" class="hidden">
                 <div class="pattern-group"><label for="evo-fecha-hora">Fecha y Hora</label><input type="text" id="evo-fecha-hora"></div>
                 <div class="pattern-group"><label for="evo-resumen">Resumen del Estado General</label><textarea id="evo-resumen" placeholder="Ej: Paciente estable, afebril, buena tolerancia a la dieta..."></textarea></div>
                 <div class="pattern-group"><label for="evo-cambios">Cambios o Eventos Relevantes</label><textarea id="evo-cambios" placeholder="Ej: Presentó pico febril de 38.5ºC, se extrajo hemocultivo..."></textarea></div>
                 <div class="pattern-group"><label for="evo-plan">Plan a Seguir</label><textarea id="evo-plan" placeholder="Ej: Mantener misma pauta. Pendiente de resultados..."></textarea></div>
            </div>

            <button type="button" id="generate-btn">Generar Texto</button>

            <div class="result-container">
                <div class="result-header"><h2>Nota de Evolución</h2><button type="button" id="copy-report-btn" class="utility-btn">Copiar Evolución</button></div>
                <textarea id="result-text" placeholder="Aquí aparecerá el informe principal..."></textarea>
                <div class="result-header"><h2>Recomendaciones y Plan</h2><button type="button" id="copy-recs-btn" class="utility-btn">Copiar Recomendaciones</button></div>
                <textarea id="recommendations-text" placeholder="Aquí aparecerán las recomendaciones..."></textarea>
                <div class="result-header"><h3>Resumen (Palabras Clave)</h3><button type="button" id="copy-keywords-btn" class="utility-btn">Copiar Claves</button></div>
                <textarea id="keywords-text" placeholder="Aquí aparecerán las palabras clave del informe..."></textarea>
                
                <div class="export-section">
                    <button type="button" id="export-pdf-btn" class="utility-btn">Exportar a PDF</button>
                </div>
            </div>
             <div style="margin-top: 20px; text-align: right;">
                 <button type="button" id="clear-btn" class="utility-btn">Limpiar Formulario</button>
            </div>
        </form>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DOMElements = {
            contextoSelector: document.getElementById('contexto-informe'),
            themeSelect: document.getElementById('theme-select'),
            formSections: {
                urgencias: document.getElementById('urgencias-fields'),
                planta: document.getElementById('planta-fields'),
                evolutivo: document.getElementById('evolutivo-fields')
            },
            allFormInputs: document.querySelectorAll('#note-form input, #note-form textarea, #note-form select'),
            clearBtn: document.getElementById('clear-btn'),
            generateBtn: document.getElementById('generate-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            embarazoContainer: document.getElementById('urg-embarazo-container'),
            sexoSelector: document.getElementById('urg-sexo'),
            resultText: document.getElementById('result-text'),
            recommendationsText: document.getElementById('recommendations-text'),
            keywordsText: document.getElementById('keywords-text'),
            copyReportBtn: document.getElementById('copy-report-btn'),
            copyRecsBtn: document.getElementById('copy-recs-btn'),
            copyKeywordsBtn: document.getElementById('copy-keywords-btn'),
        };

        const WordCounterManager = {
            init() {
                document.querySelectorAll('.pattern-group textarea').forEach(textarea => {
                    const counter = document.createElement('span');
                    counter.className = 'word-counter';
                    textarea.insertAdjacentElement('afterend', counter);
                    textarea.addEventListener('input', () => this.update(textarea, counter));
                    this.update(textarea, counter);
                });
            },
            update(textarea, counter) {
                const text = textarea.value;
                const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).filter(Boolean).length;
                counter.textContent = `${wordCount} ${wordCount === 1 ? 'palabra' : 'palabras'}`;
            },
            updateAllVisible() {
                document.querySelectorAll('.pattern-group textarea').forEach(textarea => {
                     if (textarea.offsetParent !== null) {
                        const counter = textarea.nextElementSibling;
                        if(counter && counter.classList.contains('word-counter')) {
                            this.update(textarea, counter);
                        }
                     }
                });
            }
        };

        const FormManager = {
            init() {
                DOMElements.contextoSelector.addEventListener('change', this.toggleFields);
                DOMElements.allFormInputs.forEach(input => input.addEventListener('input', this.saveState));
                DOMElements.clearBtn.addEventListener('click', this.clear);
                DOMElements.sexoSelector.addEventListener('change', this.toggleEmbarazoField);
                this.toggleFields();
                this.setInitialDateTime();
            },
            saveState() {
                const contexto = DOMElements.contextoSelector.value;
                const data = {};
                const activeForm = DOMElements.formSections[contexto];
                if (activeForm) {
                    activeForm.querySelectorAll('input, textarea, select').forEach(el => { data[el.id] = el.value; });
                    localStorage.setItem(`axiomNoteData_${contexto}`, JSON.stringify(data));
                }
            },
            loadState(contexto) {
                const savedData = localStorage.getItem(`axiomNoteData_${contexto}`);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    for (const id in data) {
                        const element = document.getElementById(id);
                        if (element) element.value = data[id];
                    }
                }
            },
            toggleFields() {
                const contexto = DOMElements.contextoSelector.value;
                Object.values(DOMElements.formSections).forEach(section => section.classList.add('hidden'));
                const activeSection = DOMElements.formSections[contexto];
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                    FormManager.loadState(contexto);
                }
                FormManager.toggleEmbarazoField();
                WordCounterManager.updateAllVisible();
            },
            clear() {
                const contexto = DOMElements.contextoSelector.value;
                const activeForm = DOMElements.formSections[contexto];
                if (activeForm) {
                    activeForm.querySelectorAll('input, textarea, select').forEach(field => {
                        if (field.tagName === 'SELECT') field.selectedIndex = 0; else field.value = '';
                    });
                    localStorage.removeItem(`axiomNoteData_${contexto}`);
                }
                this.setInitialDateTime();
                WordCounterManager.updateAllVisible();
            },
            toggleEmbarazoField() {
                const isWoman = DOMElements.sexoSelector.value === 'Mujer';
                DOMElements.embarazoContainer.classList.toggle('hidden', !isWoman);
            },
            setDateTime(fieldId) {
                const field = document.getElementById(fieldId);
                if (field && !field.value) {
                    const now = new Date();
                    const formattedDateTime = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    field.value = formattedDateTime;
                }
            },
            setInitialDateTime() {
                this.setDateTime('urg-fecha-hora');
                this.setDateTime('evo-fecha-hora');
            }
        };

        const ThemeManager = {
            init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.apply(savedTheme);
                DOMElements.themeSelect.value = savedTheme;
                DOMElements.themeSelect.addEventListener('change', (e) => {
                    const newTheme = e.target.value;
                    localStorage.setItem('theme', newTheme);
                    this.apply(newTheme);
                });
            },
            apply(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); }
        };
        
        async function generateNote() {
            DOMElements.generateBtn.disabled = true;
            DOMElements.generateBtn.textContent = "Generando...";
            const contexto = DOMElements.contextoSelector.value;
            let incomingData = { contexto };
            DOMElements.formSections[contexto].querySelectorAll('input, textarea, select').forEach(field => {
                if (field.id && field.value.trim() !== '' && !field.closest('.hidden')) {
                    const key = field.id.replace(`${contexto}-`, '');
                    incomingData[key] = field.value;
                }
            });
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ incomingData }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Error del servidor: ${response.statusText}`);
                }
                const data = await response.json();
                DOMElements.resultText.value = data.report || "";
                DOMElements.recommendationsText.value = data.recommendations || "";
                DOMElements.keywordsText.value = data.keywords || "";
            } catch (error) {
                DOMElements.resultText.value = `Error: ${error.message}`;
            } finally {
                DOMElements.generateBtn.disabled = false;
                DOMElements.generateBtn.textContent = "Generar Texto";
            }
        }
        
        function exportToPDF() {
            const reportText = DOMElements.resultText.value;
            if (!reportText.trim()) { alert('No hay informe generado para exportar.'); return; }
            const contexto = DOMElements.contextoSelector.value;
            let nombre = 'N/A', edad = 'N/A', fecha = new Date().toLocaleString('es-ES');
            const activeForm = DOMElements.formSections[contexto];
            if(activeForm) {
                const nombreEl = activeForm.querySelector('input[id*="-nombre"]');
                const edadEl = activeForm.querySelector('input[id*="-edad"]');
                const fechaEl = activeForm.querySelector('input[id*="-fecha-hora"]');
                if(nombreEl) nombre = nombreEl.value || 'N/A';
                if(edadEl) edad = edadEl.value || 'N/A';
                if(fechaEl) fecha = fechaEl.value || new Date().toLocaleString('es-ES');
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("Times-Roman");
            let y = 20;
            doc.setFontSize(18);
            doc.text("Informe Clínico - Axiom Note", 105, y, { align: "center" });
            y += 15;
            doc.setFontSize(12);
            doc.text(`Paciente: ${nombre}`, 15, y);
            doc.text(`Edad: ${edad}`, 15, y + 7);
            doc.text(`Fecha del Informe: ${fecha}`, 15, y + 14);
            y += 28;
            doc.setLineWidth(0.5);
            doc.line(15, y, 195, y);
            y += 10;
            const addSection = (title, textContent) => {
                if (!textContent || !textContent.trim()) return;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(title, 15, y);
                y += 8;
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                const splitText = doc.splitTextToSize(textContent, 180);
                splitText.forEach(line => {
                    if (y > 280) { doc.addPage(); y = 20; }
                    doc.text(line, 15, y);
                    y += 7;
                });
                y += 10;
            };
            addSection("Nota de Evolución", DOMElements.resultText.value);
            addSection("Recomendaciones y Plan", DOMElements.recommendationsText.value);
            addSection("Resumen (Palabras Clave)", DOMElements.keywordsText.value);
            const fileName = `Informe_${nombre.replace(/\s+/g, '_') || 'AxiomNote'}.pdf`;
            doc.save(fileName);
        }

        function copyToClipboard(element, button) {
            if (!element.value) return;
            navigator.clipboard.writeText(element.value).then(() => {
                const originalText = button.textContent;
                button.textContent = "¡Copiado!";
                setTimeout(() => { button.textContent = originalText; }, 2000);
            });
        }
        
        DOMElements.generateBtn.addEventListener('click', generateNote);
        DOMElements.exportPdfBtn.addEventListener('click', exportToPDF);
        DOMElements.copyReportBtn.addEventListener('click', () => copyToClipboard(DOMElements.resultText, DOMElements.copyReportBtn));
        DOMElements.copyRecsBtn.addEventListener('click', () => copyToClipboard(DOMElements.recommendationsText, DOMElements.copyRecsBtn));
        DOMElements.copyKeywordsBtn.addEventListener('click', () => copyToClipboard(DOMElements.keywordsText, DOMElements.copyKeywordsBtn));
        
        const App = {
            init() {
                FormManager.init();
                ThemeManager.init();
                WordCounterManager.init();
            }
        };

        App.init();
    });
    </script>
</body>
</html>

