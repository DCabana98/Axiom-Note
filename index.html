<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axiom Note - v3.8</title>
    <style>
        :root {
            --bg-color: #f4f7f9; --container-bg-color: #ffffff; --text-color: #333;
            --header-color: #2c3e50; --label-color: #34495e; --border-color: #ccc;
            --input-bg-color: #ffffff; --result-bg-color: #f9fafb; --shadow-color: rgba(0, 0, 0, 0.08);
            --utility-btn-bg: #ecf0f1; --utility-btn-text: #2c3e50; --utility-btn-border: #bdc3c7;
            --snippet-icon-color: #7f8c8d;
        }
        body.dark-mode {
            --bg-color: #1a1a2e; --container-bg-color: #16213e; --text-color: #e0e0e0;
            --header-color: #ffffff; --label-color: #a7b4c4; --border-color: #555;
            --input-bg-color: #2c3e50; --result-bg-color: #0f3460; --shadow-color: rgba(0, 0, 0, 0.2);
            --utility-btn-bg: #2c3e50; --utility-btn-text: #e0e0e0; --utility-btn-border: #555;
            --snippet-icon-color: #a7b4c4;
        }
        body { font-family: "Times New Roman", Times, serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--container-bg-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); position: relative; transition: background-color 0.3s; }
        .top-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 0.9em; margin-bottom: 0; color: var(--label-color); }
        .control-group select, .control-group button {
            background-color: var(--input-bg-color); color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 4px 8px; font-family: inherit;
        }
        .control-group button { cursor: pointer; }
        h1 { text-align: center; color: var(--header-color); margin-top: 60px; margin-bottom: 30px; font-size: 2em; text-transform: uppercase; }
        .form-section { border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .datos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .pattern-group { margin-bottom: 25px; position: relative; }
        h3 { color: var(--label-color); border-bottom: 2px solid var(--utility-btn-bg); padding-bottom: 10px; margin-top: 30px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--label-color); padding-right: 30px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1em; font-family: inherit; background-color: var(--input-bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        #generate-btn { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        #generate-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .result-container { margin-top: 40px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h2 { color: var(--header-color); margin: 0; }
        .utility-btn { padding: 8px 12px; font-size: 0.9em; background-color: var(--utility-btn-bg); color: var(--utility-btn-text); border: 1px solid var(--utility-btn-border); border-radius: 6px; cursor: pointer; }
        .hidden { display: none; }
        
        /* --- ESTILOS PARA MODALES --- */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background-color: var(--container-bg-color); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal h4 { margin-top: 0; color: var(--header-color); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        
        /* --- ESTILOS PARA PLANTILLAS (SNIPPETS) --- */
        .snippet-btn { position: absolute; top: -2px; right: 0; background: none; border: none; cursor: pointer; color: var(--snippet-icon-color); padding: 4px; display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; opacity: 0.7; transition: opacity 0.2s; }
        .snippet-btn:hover { opacity: 1; }
        .snippet-btn svg { width: 16px; height: 16px; }
        #snippet-list { list-style: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        #snippet-list li, #profile-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; }
        #snippet-list li { cursor: pointer; }
        #snippet-list li:hover { background-color: var(--result-bg-color); }
        .delete-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        
        /* --- ESTILOS PARA GESTOR DE PERFILES --- */
        #profile-list { list-style: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        #profile-list span { flex-grow: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="control-group">
                <label for="profile-select">Perfil:</label>
                <select id="profile-select"></select>
                <button id="manage-profiles-btn" title="Gestionar Perfiles">⚙️</button>
            </div>
            <div class="control-group">
                <label for="theme-select">Tema:</label>
                <select id="theme-select">
                    <option value="light">Claro</option>
                    <option value="dark">Oscuro</option>
                </select>
            </div>
        </div>

        <h1>Axiom Note</h1>
        <form id="note-form">
            <!-- Contenido del formulario sin cambios -->
             <div class="form-section">
                <label for="contexto-informe">Contexto del Informe</label>
                <select id="contexto-informe">
                    <option value="urgencias">Urgencias</option>
                    <option value="planta">Ingreso en Planta</option>
                    <option value="evolutivo">Evolutivo de planta</option>
                </select>
            </div>
            <div id="urgencias-fields" class="hidden">
                 <div class="pattern-group"><label for="urg-motivo">Motivo de Consulta</label><button type="button" class="snippet-btn" data-target="urg-motivo" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-motivo"></textarea></div>
                 <!-- Resto de campos de urgencias con su snippet-btn -->
            </div>
             <div id="planta-fields" class="hidden">
                 <div class="pattern-group"><label for="planta-motivo_ingreso">Motivo de Ingreso</label><button type="button" class="snippet-btn" data-target="planta-motivo_ingreso" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-motivo_ingreso"></textarea></div>
                 <!-- Resto de campos de planta con su snippet-btn -->
            </div>
            <div id="evolutivo-fields" class="hidden">
                 <div class="pattern-group"><label for="evo-resumen">Resumen del Estado General</label><button type="button" class="snippet-btn" data-target="evo-resumen" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="evo-resumen"></textarea></div>
                 <!-- Resto de campos de evolutivo con su snippet-btn -->
            </div>
            <button type="button" id="generate-btn">Generar Texto</button>
            <!-- Contenedores de resultado y botón de limpiar -->
        </form>
    </div>

    <!-- MODAL PARA GESTIONAR SNIPPETS -->
    <div id="snippet-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h4 id="snippet-modal-title">Plantillas para...</h4>
            <p>Selecciona una plantilla para insertarla o crea una nueva.</p>
            <ul id="snippet-list"></ul>
            <div id="new-snippet-section">
                <label for="new-snippet-name">Nombre de la nueva plantilla:</label>
                <input type="text" id="new-snippet-name" placeholder="Ej: Exploración normal">
                <button type="button" id="save-snippet-btn" class="utility-btn" style="margin-top: 10px;">Guardar texto actual como plantilla</button>
            </div>
            <div class="modal-buttons">
                <button type="button" id="close-snippet-modal-btn" class="utility-btn">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA GESTIONAR PERFILES -->
    <div id="profiles-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h4>Gestionar Perfiles de Plantillas</h4>
            <ul id="profile-list"></ul>
            <div>
                <label for="new-profile-name">Nombre del nuevo perfil:</label>
                <input type="text" id="new-profile-name" placeholder="Ej: Neumología">
                <button type="button" id="add-profile-btn" class="utility-btn" style="margin-top: 10px;">Crear Perfil</button>
            </div>
            <div class="modal-buttons">
                <button type="button" id="close-profiles-modal-btn" class="utility-btn">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS GLOBALES ---
        const contextoSelector = document.getElementById('contexto-informe');
        const profileSelect = document.getElementById('profile-select');
        const manageProfilesBtn = document.getElementById('manage-profiles-btn');
        const allFormInputs = document.querySelectorAll('#note-form input, #note-form textarea, #note-form select');

        // --- LÓGICA DE DATOS (PERFILES Y SNIPPETS) ---
        let appData = {};

        function loadData() {
            const data = localStorage.getItem('axiomNoteProfiles');
            if (data) {
                appData = JSON.parse(data);
            } else {
                // Estructura de datos inicial
                appData = {
                    profiles: [{ id: 'default', name: 'General' }],
                    activeProfileId: 'default',
                    snippets: { 'default': {} }
                };
            }
        }

        function saveData() {
            localStorage.setItem('axiomNoteProfiles', JSON.stringify(appData));
        }

        // --- GESTIÓN DE PERFILES ---
        const profilesModal = document.getElementById('profiles-modal');
        const profileList = document.getElementById('profile-list');
        const newProfileNameInput = document.getElementById('new-profile-name');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const closeProfilesModalBtn = document.getElementById('close-profiles-modal-btn');

        function populateProfileSelector() {
            profileSelect.innerHTML = '';
            appData.profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name;
                profileSelect.appendChild(option);
            });
            profileSelect.value = appData.activeProfileId;
        }

        function renderProfileList() {
            profileList.innerHTML = '';
            appData.profiles.forEach(profile => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${profile.name}</span>`;
                if (profile.id !== 'default') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'X';
                    deleteBtn.onclick = () => deleteProfile(profile.id);
                    li.appendChild(deleteBtn);
                }
                profileList.appendChild(li);
            });
        }

        function addProfile() {
            const name = newProfileNameInput.value.trim();
            if (name) {
                const newProfile = {
                    id: `profile_${Date.now()}`,
                    name: name
                };
                appData.profiles.push(newProfile);
                appData.snippets[newProfile.id] = {};
                newProfileNameInput.value = '';
                saveData();
                populateProfileSelector();
                renderProfileList();
            }
        }

        function deleteProfile(profileId) {
            if (confirm('¿Seguro que quieres borrar este perfil y todas sus plantillas? Esta acción no se puede deshacer.')) {
                appData.profiles = appData.profiles.filter(p => p.id !== profileId);
                delete appData.snippets[profileId];
                if (appData.activeProfileId === profileId) {
                    appData.activeProfileId = 'default';
                }
                saveData();
                populateProfileSelector();
                renderProfileList();
            }
        }
        
        manageProfilesBtn.addEventListener('click', () => {
            renderProfileList();
            profilesModal.classList.remove('hidden');
        });
        addProfileBtn.addEventListener('click', addProfile);
        closeProfilesModalBtn.addEventListener('click', () => profilesModal.classList.add('hidden'));
        profileSelect.addEventListener('change', () => {
            appData.activeProfileId = profileSelect.value;
            saveData();
            // No es necesario recargar el formulario, los snippets se cargan al abrir el modal
        });
        
        // --- LÓGICA DE SNIPPETS (MODIFICADA PARA PERFILES) ---
        const snippetModal = document.getElementById('snippet-modal');
        let currentSnippetTargetId = null;

        function getSnippets(targetId) {
            const activeProfileId = appData.activeProfileId;
            if (!appData.snippets[activeProfileId]) {
                appData.snippets[activeProfileId] = {};
            }
            if (!appData.snippets[activeProfileId][targetId]) {
                appData.snippets[activeProfileId][targetId] = [];
            }
            return appData.snippets[activeProfileId][targetId];
        }

        function saveSnippets(targetId, snippets) {
            const activeProfileId = appData.activeProfileId;
            appData.snippets[activeProfileId][targetId] = snippets;
            saveData();
            renderSnippets(targetId);
        }
        
        // El resto de la lógica de snippets (renderSnippets, openModal, closeModal, etc.) sigue igual
        // pero ahora utiliza las funciones getSnippets y saveSnippets que son conscientes del perfil.

        document.querySelectorAll('.snippet-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentSnippetTargetId = btn.dataset.target;
                // ... abrir el modal de snippets
                const targetLabel = document.querySelector(`label[for='${currentSnippetTargetId}']`).textContent;
                document.getElementById('snippet-modal-title').textContent = `Plantillas para "${targetLabel}"`;
                document.getElementById('new-snippet-name').value = '';
                renderSnippets(currentSnippetTargetId);
                snippetModal.classList.remove('hidden');
            });
        });
        
        // ... (resto de funciones de snippets y formulario)
        
        // --- INICIALIZACIÓN GENERAL ---
        loadData();
        populateProfileSelector();
        // ... (resto de la inicialización: tema, autosave, toggleFields, etc.)
    });
    </script>
</body>
</html>

