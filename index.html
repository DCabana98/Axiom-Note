<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axiom Note - v4.0</title>
    <style>
        :root {
            --bg-color: #f4f7f9; --container-bg-color: #ffffff; --text-color: #333;
            --header-color: #2c3e50; --label-color: #34495e; --border-color: #ccc;
            --input-bg-color: #ffffff; --result-bg-color: #f9fafb; --shadow-color: rgba(0, 0, 0, 0.08);
            --utility-btn-bg: #ecf0f1; --utility-btn-text: #2c3e50; --utility-btn-border: #bdc3c7;
            --snippet-icon-color: #7f8c8d;
        }
        body.dark-mode {
            --bg-color: #1a1a2e; --container-bg-color: #16213e; --text-color: #e0e0e0;
            --header-color: #ffffff; --label-color: #a7b4c4; --border-color: #555;
            --input-bg-color: #2c3e50; --result-bg-color: #0f3460; --shadow-color: rgba(0, 0, 0, 0.2);
            --utility-btn-bg: #2c3e50; --utility-btn-text: #e0e0e0; --utility-btn-border: #555;
            --snippet-icon-color: #a7b4c4;
        }
        body { font-family: "Times New Roman", Times, serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--container-bg-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); position: relative; transition: background-color 0.3s; }
        .top-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 0.9em; margin-bottom: 0; color: var(--label-color); }
        .control-group select, .control-group button {
            background-color: var(--input-bg-color); color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 4px 8px; font-family: inherit;
        }
        .control-group button { cursor: pointer; }
        h1 { text-align: center; color: var(--header-color); margin-top: 60px; margin-bottom: 30px; font-size: 2em; text-transform: uppercase; }
        .form-section { border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .datos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .pattern-group { margin-bottom: 25px; position: relative; }
        h3 { color: var(--label-color); border-bottom: 2px solid var(--utility-btn-bg); padding-bottom: 10px; margin-top: 30px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--label-color); padding-right: 30px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1em; font-family: inherit; background-color: var(--input-bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        textarea { min-height: 80px; resize: vertical; }
        #generate-btn { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        #generate-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .result-container { margin-top: 40px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 20px; }
        h2 { color: var(--header-color); margin: 0; }
        .utility-btn { padding: 8px 12px; font-size: 0.9em; background-color: var(--utility-btn-bg); color: var(--utility-btn-text); border: 1px solid var(--utility-btn-border); border-radius: 6px; cursor: pointer; }
        .hidden { display: none; }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background-color: var(--container-bg-color); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal h4 { margin-top: 0; color: var(--header-color); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        
        .snippet-btn { position: absolute; top: -2px; right: 0; background: none; border: none; cursor: pointer; color: var(--snippet-icon-color); padding: 4px; display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; opacity: 0.7; transition: opacity 0.2s; }
        .snippet-btn:hover { opacity: 1; }
        .snippet-btn svg { width: 16px; height: 16px; }
        #snippet-list, #profile-list { list-style: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        #snippet-list li, #profile-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; }
        #snippet-list li { cursor: pointer; }
        #snippet-list li:hover { background-color: var(--result-bg-color); }
        .delete-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        #profile-list span { flex-grow: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="control-group">
                <label for="profile-select">Perfil:</label>
                <select id="profile-select"></select>
                <button id="manage-profiles-btn" title="Gestionar Perfiles">⚙️</button>
            </div>
            <div class="control-group">
                <label for="theme-select">Tema:</label>
                <select id="theme-select">
                    <option value="light">Claro</option>
                    <option value="dark">Oscuro</option>
                </select>
            </div>
        </div>

        <h1>Axiom Note</h1>
        <form id="note-form">
            <div class="form-section">
                <label for="contexto-informe">Contexto del Informe</label>
                <select id="contexto-informe">
                    <option value="urgencias">Urgencias</option>
                    <option value="planta">Ingreso en Planta</option>
                    <option value="evolutivo">Evolutivo de planta</option>
                </select>
            </div>
            
            <div id="urgencias-fields" class="hidden">
                <div class="form-section datos-grid">
                    <div><label for="urg-fecha-hora">Fecha y Hora</label><input type="text" id="urg-fecha-hora"></div>
                    <div><label for="urg-nombre">Nombre</label><input type="text" id="urg-nombre"></div>
                    <div><label for="urg-edad">Edad</label><input type="number" id="urg-edad"></div>
                    <div><label for="urg-sexo">Sexo</label><select id="urg-sexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                    <div id="urg-embarazo-container" class="hidden"><label for="urg-embarazo">Embarazo</label><select id="urg-embarazo"><option value="No">No</option><option value="Sí">Sí</option><option value="No sabe">No sabe</option></select></div>
                    <div><label for="urg-alergias">Alergias</label><input type="text" id="urg-alergias" placeholder="Ej: Penicilina..."></div>
                </div>
                <div class="pattern-group"><label for="urg-motivo">Motivo de Consulta</label><button type="button" class="snippet-btn" data-target="urg-motivo" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-motivo"></textarea></div>
                <div class="pattern-group"><label for="urg-triaje">Constantes y Triaje</label><button type="button" class="snippet-btn" data-target="urg-triaje" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-triaje"></textarea></div>
                <div class="pattern-group"><label for="urg-historia">Historia Actual</label><button type="button" class="snippet-btn" data-target="urg-historia" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-historia"></textarea></div>
                <div class="pattern-group"><label for="urg-antecedentes">Antecedentes</label><button type="button" class="snippet-btn" data-target="urg-antecedentes" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-antecedentes"></textarea></div>
                <div class="pattern-group"><label for="urg-exploracion">Exploración Física</label><button type="button" class="snippet-btn" data-target="urg-exploracion" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-exploracion"></textarea></div>
                <div class="pattern-group"><label for="urg-pruebas">Pruebas Realizadas</label><button type="button" class="snippet-btn" data-target="urg-pruebas" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-pruebas"></textarea></div>
                <div class="pattern-group"><label for="urg-sospecha">Sospecha Diagnóstica</label><button type="button" class="snippet-btn" data-target="urg-sospecha" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-sospecha"></textarea></div>
                <div class="pattern-group"><label for="urg-plan">Plan Inmediato</label><button type="button" class="snippet-btn" data-target="urg-plan" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="urg-plan"></textarea></div>
            </div>
            <div id="planta-fields" class="hidden">
                 <h3>Información Inicial</h3>
                 <div class="form-section datos-grid">
                    <div><label for="planta-nombre">Nombre</label><input type="text" id="planta-nombre"></div>
                    <div><label for="planta-edad">Edad</label><input type="number" id="planta-edad"></div>
                    <div><label for="planta-sexo">Sexo</label><select id="planta-sexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                 </div>
                 <h3>Bloque 1: Contexto</h3>
                 <div class="pattern-group"><label for="planta-motivo_ingreso">Motivo de Ingreso</label><button type="button" class="snippet-btn" data-target="planta-motivo_ingreso" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-motivo_ingreso"></textarea></div>
                 <div class="pattern-group"><label for="planta-antecedentes">Antecedentes</label><button type="button" class="snippet-btn" data-target="planta-antecedentes" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-antecedentes"></textarea></div>
                 <h3>Bloque 2: Evaluación</h3>
                 <div class="pattern-group"><label for="planta-exploracion">Exploración Física</label><button type="button" class="snippet-btn" data-target="planta-exploracion" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-exploracion"></textarea></div>
                 <div class="pattern-group"><label for="planta-pruebas">Resultados Pruebas</label><button type="button" class="snippet-btn" data-target="planta-pruebas" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-pruebas"></textarea></div>
                 <h3>Bloque 3: Plan de Actuación</h3>
                 <div class="pattern-group"><label for="planta-tratamiento">Plan de Tratamiento</label><button type="button" class="snippet-btn" data-target="planta-tratamiento" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-tratamiento"></textarea></div>
                 <div class="pattern-group"><label for="planta-cuidados">Plan de Cuidados</label><button type="button" class="snippet-btn" data-target="planta-cuidados" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-cuidados"></textarea></div>
                 <div class="pattern-group"><label for="planta-intervenciones">Intervenciones</label><button type="button" class="snippet-btn" data-target="planta-intervenciones" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="planta-intervenciones"></textarea></div>
            </div>
            <div id="evolutivo-fields" class="hidden">
                 <div class="pattern-group"><label for="evo-fecha-hora">Fecha y Hora</label><input type="text" id="evo-fecha-hora"></div>
                 <div class="pattern-group"><label for="evo-resumen">Resumen Estado General</label><button type="button" class="snippet-btn" data-target="evo-resumen" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="evo-resumen"></textarea></div>
                 <div class="pattern-group"><label for="evo-cambios">Cambios o Eventos</label><button type="button" class="snippet-btn" data-target="evo-cambios" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="evo-cambios"></textarea></div>
                 <div class="pattern-group"><label for="evo-plan">Plan a Seguir</label><button type="button" class="snippet-btn" data-target="evo-plan" title="Gestionar plantillas"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2z"/></svg></button><textarea id="evo-plan"></textarea></div>
            </div>

            <button type="button" id="generate-btn">Generar Texto</button>

            <div class="result-container">
                <div class="result-header"><h2>Nota de Evolución</h2><button type="button" id="copy-report-btn" class="utility-btn">Copiar</button></div>
                <textarea id="result-text" placeholder="Aquí aparecerá el informe principal..."></textarea>
                <div class="result-header"><h2>Recomendaciones</h2><button type="button" id="copy-recs-btn" class="utility-btn">Copiar</button></div>
                <textarea id="recommendations-text" placeholder="Aquí aparecerán las recomendaciones..."></textarea>
                <div class="result-header"><h3>Palabras Clave</h3><button type="button" id="copy-keywords-btn" class="utility-btn">Copiar</button></div>
                <textarea id="keywords-text" placeholder="Aquí aparecerán las palabras clave..."></textarea>
            </div>
             <div style="margin-top: 20px; text-align: right;">
                 <button type="button" id="clear-btn" class="utility-btn">Limpiar Formulario</button>
            </div>
        </form>
    </div>

    <!-- MODALES -->
    <div id="snippet-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h4 id="snippet-modal-title">Plantillas para...</h4>
            <ul id="snippet-list"></ul>
            <div>
                <label for="new-snippet-name">Nombre plantilla:</label>
                <input type="text" id="new-snippet-name" placeholder="Ej: Exploración normal">
                <button type="button" id="save-snippet-btn" class="utility-btn" style="margin-top: 10px;">Guardar texto actual</button>
            </div>
            <div class="modal-buttons">
                <button type="button" id="close-snippet-modal-btn" class="utility-btn">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="profiles-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h4>Gestionar Perfiles</h4>
            <ul id="profile-list"></ul>
            <div>
                <label for="new-profile-name">Nuevo perfil:</label>
                <input type="text" id="new-profile-name" placeholder="Ej: Neumología">
                <button type="button" id="add-profile-btn" class="utility-btn" style="margin-top: 10px;">Crear Perfil</button>
            </div>
            <div class="modal-buttons">
                <button type="button" id="close-profiles-modal-btn" class="utility-btn">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. ELEMENTOS DEL DOM ---
        const contextoSelector = document.getElementById('contexto-informe');
        const profileSelect = document.getElementById('profile-select');
        const manageProfilesBtn = document.getElementById('manage-profiles-btn');
        const themeSelect = document.getElementById('theme-select');
        const formSections = {
            urgencias: document.getElementById('urgencias-fields'),
            planta: document.getElementById('planta-fields'),
            evolutivo: document.getElementById('evolutivo-fields')
        };
        const allFormInputs = document.querySelectorAll('#note-form input, #note-form textarea, #note-form select');
        const clearBtn = document.getElementById('clear-btn');
        const generateBtn = document.getElementById('generate-btn');
        
        // Modales de Perfiles
        const profilesModal = document.getElementById('profiles-modal');
        const profileList = document.getElementById('profile-list');
        const newProfileNameInput = document.getElementById('new-profile-name');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const closeProfilesModalBtn = document.getElementById('close-profiles-modal-btn');

        // Modales de Snippets
        const snippetModal = document.getElementById('snippet-modal');
        const snippetModalTitle = document.getElementById('snippet-modal-title');
        const snippetList = document.getElementById('snippet-list');
        const newSnippetNameInput = document.getElementById('new-snippet-name');
        const saveSnippetBtn = document.getElementById('save-snippet-btn');
        const closeSnippetModalBtn = document.getElementById('close-snippet-modal-btn');
        let currentSnippetTargetId = null;

        // --- 2. GESTIÓN DE DATOS ---
        let appData = {};

        function loadData() {
            try {
                const data = localStorage.getItem('axiomNoteProfiles_v2');
                if (data) appData = JSON.parse(data);
                else throw new Error("No data");
            } catch (e) {
                appData = {
                    profiles: [{ id: 'default', name: 'General' }],
                    activeProfileId: 'default',
                    snippets: { 'default': {} }
                };
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('axiomNoteProfiles_v2', JSON.stringify(appData));
        }

        // --- 3. LÓGICA DE PERFILES ---
        function populateProfileSelector() {
            profileSelect.innerHTML = '';
            appData.profiles.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                profileSelect.appendChild(option);
            });
            profileSelect.value = appData.activeProfileId;
        }

        function renderProfileList() {
            profileList.innerHTML = '';
            appData.profiles.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${p.name}</span>`;
                if (p.id !== 'default') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'X';
                    deleteBtn.onclick = () => deleteProfile(p.id);
                    li.appendChild(deleteBtn);
                }
                profileList.appendChild(li);
            });
        }

        function addProfile() {
            const name = newProfileNameInput.value.trim();
            if (name && !appData.profiles.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                const newId = `profile_${Date.now()}`;
                appData.profiles.push({ id: newId, name: name });
                appData.snippets[newId] = {};
                newProfileNameInput.value = '';
                saveData();
                populateProfileSelector();
                renderProfileList();
            }
        }

        function deleteProfile(profileId) {
            if (confirm('¿Borrar este perfil y todas sus plantillas?')) {
                appData.profiles = appData.profiles.filter(p => p.id !== profileId);
                delete appData.snippets[profileId];
                if (appData.activeProfileId === profileId) appData.activeProfileId = 'default';
                saveData();
                populateProfileSelector();
                renderProfileList();
            }
        }

        // --- 4. LÓGICA DE SNIPPETS ---
        function getSnippets(targetId) {
            const activeProfileId = appData.activeProfileId;
            const profileSnippets = appData.snippets[activeProfileId] || {};
            return profileSnippets[targetId] || [];
        }

        function saveCurrentSnippets(targetId, snippets) {
            const activeProfileId = appData.activeProfileId;
            if (!appData.snippets[activeProfileId]) appData.snippets[activeProfileId] = {};
            appData.snippets[activeProfileId][targetId] = snippets;
            saveData();
            renderSnippets(targetId);
        }
        
        function renderSnippets(targetId) {
            snippetList.innerHTML = '';
            const snippets = getSnippets(targetId);
            if (snippets.length === 0) {
                snippetList.innerHTML = '<li>No hay plantillas guardadas.</li>';
                return;
            }
            snippets.forEach((snippet, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${snippet.name}</span> <button class="delete-btn" data-index="${index}">X</button>`;
                li.querySelector('span').onclick = () => {
                    const targetTextarea = document.getElementById(targetId);
                    targetTextarea.value = snippet.content;
                    targetTextarea.dispatchEvent(new Event('input'));
                    closeSnippetModal();
                };
                li.querySelector('.delete-btn').onclick = (e) => {
                    e.stopPropagation();
                    snippets.splice(index, 1);
                    saveCurrentSnippets(targetId, snippets);
                };
                snippetList.appendChild(li);
            });
        }

        function openSnippetModal(targetId) {
            currentSnippetTargetId = targetId;
            const targetLabel = document.querySelector(`label[for='${targetId}']`).textContent;
            snippetModalTitle.textContent = `Plantillas para "${targetLabel}"`;
            newSnippetNameInput.value = '';
            renderSnippets(targetId);
            snippetModal.classList.remove('hidden');
        }
        
        function closeSnippetModal() { snippetModal.classList.add('hidden'); }

        // --- 5. LÓGICA DEL FORMULARIO ---
        function saveFormState() {
            const contexto = contextoSelector.value;
            const data = {};
            const activeForm = formSections[contexto];
            if (!activeForm) return;
            activeForm.querySelectorAll('input, textarea, select').forEach(el => {
                data[el.id] = el.value;
            });
            localStorage.setItem(`axiomNoteData_${contexto}`, JSON.stringify(data));
        }

        function loadFormState(contexto) {
            const savedData = localStorage.getItem(`axiomNoteData_${contexto}`);
            if (savedData) {
                const data = JSON.parse(savedData);
                for (const id in data) {
                    const element = document.getElementById(id);
                    if (element) element.value = data[id];
                }
            }
        }

        function toggleFields() {
            const contexto = contextoSelector.value;
            Object.values(formSections).forEach(section => section.classList.add('hidden'));
            if (formSections[contexto]) {
                formSections[contexto].classList.remove('hidden');
                loadFormState(contexto);
            }
            //validarFormularioParaIA();
        }

        function clearForm() {
            const contexto = contextoSelector.value;
            const activeForm = formSections[contexto];
            if (activeForm) {
                activeForm.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.tagName === 'SELECT') field.selectedIndex = 0;
                    else field.value = '';
                });
            }
            // Limpiar resultados
            localStorage.removeItem(`axiomNoteData_${contexto}`);
            //validarFormularioParaIA();
        }

        // --- 6. LÓGICA DEL TEMA ---
        function applyTheme(theme) {
            document.body.classList.toggle('dark-mode', theme === 'dark');
        }

        // --- 7. INICIALIZACIÓN ---
        loadData();
        
        // Perfiles
        populateProfileSelector();
        manageProfilesBtn.addEventListener('click', () => {
            renderProfileList();
            profilesModal.classList.remove('hidden');
        });
        addProfileBtn.addEventListener('click', addProfile);
        closeProfilesModalBtn.addEventListener('click', () => profilesModal.classList.add('hidden'));
        profilesModal.addEventListener('click', (e) => { if(e.target === profilesModal) profilesModal.classList.add('hidden'); });
        profileSelect.addEventListener('change', () => {
            appData.activeProfileId = profileSelect.value;
            saveData();
        });
        
        // Snippets
        document.querySelectorAll('.snippet-btn').forEach(btn => btn.addEventListener('click', () => openSnippetModal(btn.dataset.target)));
        closeSnippetModalBtn.addEventListener('click', closeSnippetModal);
        snippetModal.addEventListener('click', (e) => { if(e.target === snippetModal) closeSnippetModal(); });

        // Tema
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        themeSelect.value = savedTheme;
        themeSelect.addEventListener('change', () => {
            const newTheme = themeSelect.value;
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // Formulario
        contextoSelector.addEventListener('change', toggleFields);
        allFormInputs.forEach(input => input.addEventListener('input', saveFormState));
        clearBtn.addEventListener('click', clearForm);

        // Estado inicial del formulario
        toggleFields();
    });
    </script>
</body>
</html>

