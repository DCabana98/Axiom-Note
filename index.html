<!DOCTYPE html>
<html lang="es">
...
<body>
    ...
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CONSTANTES GLOBALES
            const LS_THEME_KEY = 'axiomNoteTheme';
            const LS_DATA_PREFIX = 'axiomNoteData_';

            const DOMElements = {
                // ... sin cambios ...
            };

            const WordCounterManager = {
                // ... sin cambios ...
            };

            const FormManager = {
                init() {
                    DOMElements.contextoSelector.addEventListener('change', () => {
                        this.toggleFields();
                        this.validateActiveForm(); // Validar al cambiar
                    });
                    DOMElements.allFormInputs.forEach(input => {
                        input.addEventListener('input', () => {
                            this.saveState();
                            this.validateActiveForm(); // Validar en cada input
                        });
                    });
                    DOMElements.clearBtn.addEventListener('click', this.clear.bind(this));
                    DOMElements.sexoSelector.addEventListener('change', this.toggleEmbarazoField.bind(this));
                    this.toggleFields();
                },
                saveState() {
                    const contexto = DOMElements.contextoSelector.value;
                    const data = {};
                    const activeForm = DOMElements.formSections[contexto];
                    if (activeForm) {
                        activeForm.querySelectorAll('input, textarea, select').forEach(el => { data[el.id] = el.value; });
                        localStorage.setItem(`${LS_DATA_PREFIX}${contexto}`, JSON.stringify(data));
                    }
                },
                loadState(contexto) {
                    const savedData = localStorage.getItem(`${LS_DATA_PREFIX}${contexto}`);
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        for (const id in data) {
                            const element = document.getElementById(id);
                            if (element) element.value = data[id];
                        }
                    }
                },
                toggleFields() {
                    // ... Lógica actual ...
                    this.loadState(DOMElements.contextoSelector.value);
                    this.setInitialDateTime();
                    this.toggleEmbarazoField();
                    WordCounterManager.updateAllVisible();
                    this.validateActiveForm(); // Asegurarse de validar el estado inicial
                },
                clear() {
                    // ... Lógica actual ...
                    this.validateActiveForm(); // Re-validar después de limpiar
                },
                // --- NUEVA FUNCIÓN DE VALIDACIÓN ---
                validateActiveForm() {
                    const contexto = DOMElements.contextoSelector.value;
                    const activeForm = DOMElements.formSections[contexto];
                    let isFormValid = true;
                    if (activeForm) {
                        // Comprobar si algún campo requerido y visible está vacío
                        activeForm.querySelectorAll('[required]').forEach(input => {
                            if (!input.closest('.hidden') && input.value.trim() === '') {
                                isFormValid = false;
                            }
                        });
                    } else {
                        isFormValid = false;
                    }
                    DOMElements.generateBtn.disabled = !isFormValid;
                },
                // ... resto de funciones sin cambios ...
            };

            const ThemeManager = {
                init() {
                    const savedTheme = localStorage.getItem(LS_THEME_KEY) || 'light';
                    this.apply(savedTheme);
                    DOMElements.themeSelect.value = savedTheme;
                    DOMElements.themeSelect.addEventListener('change', (e) => {
                        const newTheme = e.target.value;
                        localStorage.setItem(LS_THEME_KEY, newTheme);
                        this.apply(newTheme);
                    });
                },
                apply(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); }
            };

            const ActionManager = {
                // ... sin cambios en init() ni en las funciones de copiado ...

                // --- VERSIÓN MEJORADA CON STREAMING (EJEMPLO CONCEPTUAL) ---
                async generateNote() {
                    DOMElements.generateBtn.disabled = true;
                    DOMElements.generateBtn.textContent = "Generando...";
                    
                    const contexto = DOMElements.contextoSelector.value;
                    let incomingData = { contexto };
                    // ... (recolectar datos del form) ...

                    try {
                        const response = await fetch('/api/generate', { /* ... */ });
                        if (!response.ok || !response.body) {
                            throw new Error('La respuesta del servidor no es válida.');
                        }
                        
                        // Limpiamos los campos de resultados
                        DOMElements.resultText.value = "";
                        DOMElements.recommendationsText.value = "";
                        DOMElements.keywordsText.value = "";

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            
                            // Asumimos que el backend puede enviar diferentes partes como JSON
                            // Por ejemplo: {"type": "report", "content": "Paciente que..."}
                            const parts = buffer.split('\n');
                            buffer = parts.pop(); // Guardar la parte incompleta para la siguiente iteración

                            for (const part of parts) {
                                try {
                                    const parsed = JSON.parse(part);
                                    if (parsed.type === 'report') {
                                        DOMElements.resultText.value += parsed.content;
                                    } else if (parsed.type === 'recommendations') {
                                        DOMElements.recommendationsText.value += parsed.content;
                                    } else if (parsed.type === 'keywords') {
                                        DOMElements.keywordsText.value += parsed.content;
                                    }
                                } catch (e) {
                                    // Ignorar JSONs incompletos, se procesarán con el siguiente chunk
                                }
                            }
                        }
                    } catch (error) {
                        DOMElements.resultText.value = `Error: ${error.message}`;
                    } finally {
                        DOMElements.generateBtn.disabled = false;
                        DOMElements.generateBtn.textContent = "Generar Texto";
                        FormManager.validateActiveForm(); // Re-validar por si acaso
                    }
                },
                // ... resto de funciones ...
            };

            const App = {
                init() {
                    ThemeManager.init();
                    WordCounterManager.init();
                    ActionManager.init();
                    FormManager.init(); // Mover al final para que la validación inicial se ejecute después de todo
                }
            };

            App.init();
        });
    </script>
</body>
</html>