<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axiom Note</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="control-group">
                <label for="theme-select">Tema:</label>
                <select id="theme-select">
                    <option value="light">Claro</option>
                    <option value="dark">Oscuro</option>
                </select>
            </div>
        </div>

        <h1>Axiom Note</h1>
        <form id="note-form">
            <div class="form-section">
                <label for="contexto-informe">Contexto del Informe</label>
                <select id="contexto-informe">
                    <option value="urgencias">Urgencias</option>
                    <option value="planta">Ingreso en Planta</option>
                    <option value="evolutivo">Evolutivo de planta</option>
                </select>
            </div>
            
            <div id="urgencias-fields" class="hidden">
                <details open>
                    <summary>Datos del Paciente</summary>
                    <fieldset>
                        <div class="datos-grid">
                            <div><label for="urg-fecha-hora">Fecha y Hora de Llegada</label><input type="datetime-local" id="urg-fecha-hora"></div>
                            <div><label for="urg-nombre">Nombre</label><input type="text" id="urg-nombre"></div>
                            <div><label for="urg-edad">Edad</label><input type="number" id="urg-edad"></div>
                            <div><label for="urg-sexo">Sexo</label><select id="urg-sexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                            <div id="urg-embarazo-container" class="hidden"><label for="urg-embarazo">Embarazo</label><select id="urg-embarazo"><option value="No">No</option><option value="Sí">Sí</option><option value="No sabe">No sabe</option></select></div>
                            <div><label for="urg-alergias">Alergias</label><input type="text" id="urg-alergias" placeholder="Ej: Penicilina..."></div>
                        </div>
                    </fieldset>
                </details>
                <details>
                    <summary>Evaluación Clínica</summary>
                    <fieldset>
                        <div class="pattern-group"><label for="urg-motivo">Motivo de Consulta</label><textarea id="urg-motivo" placeholder="Dolor torácico opresivo..."></textarea></div>
                        <div class="pattern-group"><label for="urg-triaje">Constantes y Nivel de Triaje</label><textarea id="urg-triaje" placeholder="TA 150/90, FC 110 lpm, SatO2 96%, Nivel II..."></textarea></div>
                        <div class="pattern-group"><label for="urg-historia">Historia Actual</label><textarea id="urg-historia" placeholder="Inicio de síntomas, evolución..."></textarea></div>
                        <div class="pattern-group"><label for="urg-antecedentes">Antecedentes Relevantes</label><textarea id="urg-antecedentes" placeholder="Medicación crónica, tóxicos..."></textarea></div>
                        <div class="pattern-group"><label for="urg-exploracion">Exploración Física</label><textarea id="urg-exploracion" placeholder="Auscultación, palpación, estado neurológico..."></textarea></div>
                    </fieldset>
                </details>
                <details>
                    <summary>Plan y Diagnóstico</summary>
                    <fieldset>
                        <div class="pattern-group"><label for="urg-pruebas">Pruebas Realizadas en Urgencias</label><textarea id="urg-pruebas" placeholder="Resultados de ECG, analítica, test rápidos..."></textarea></div>
                        <div class="pattern-group"><label for="urg-sospecha">Sospecha Diagnóstica</label><textarea id="urg-sospecha" placeholder="Ej: Síndrome Coronario Agudo..."></textarea></div>
                        <div class="pattern-group"><label for="urg-plan">Plan Inmediato y Tratamiento</label><textarea id="urg-plan" placeholder="Ej: Se administra AAS, se solicita analítica..."></textarea></div>
                    </fieldset>
                </details>
            </div>

            <div id="planta-fields" class="hidden">
                <details open>
                    <summary>Información del Paciente</summary>
                    <fieldset>
                        <div class="datos-grid">
                            <div><label for="planta-nombre">Nombre del Paciente</label><input type="text" id="planta-nombre"></div>
                            <div><label for="planta-edad">Edad</label><input type="number" id="planta-edad"></div>
                            <div><label for="planta-sexo">Sexo</label><select id="planta-sexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                        </div>
                    </fieldset>
                </details>
                <details>
                    <summary>Contexto del Paciente</summary>
                    <fieldset>
                        <div class="pattern-group"><label for="planta-motivo_ingreso">Motivo de Ingreso</label><textarea id="planta-motivo_ingreso" placeholder="Ej: Ingresa desde Urgencias por insuficiencia cardíaca descompensada."></textarea></div>
                        <div class="pattern-group"><label for="planta-alergias">Alergias</label><textarea id="planta-alergias" placeholder="Ej: Penicilina, AINEs, Contrastes Yodados..."></textarea></div>
                        <div class="pattern-group"><label for="planta-antecedentes">Antecedentes Personales</label><textarea id="planta-antecedentes" placeholder="Ej: HTA, DM2 en tto con Metformina, apendicectomía en la infancia."></textarea></div>
                    </fieldset>
                </details>
                <details>
                    <summary>Evaluación Clínica</summary>
                    <fieldset>
                        <div class="pattern-group"><label for="planta-exploracion">Exploración Física</label><textarea id="planta-exploracion" placeholder="Ej: Consciente y orientado. Eupneico. ACR: Tonos rítmicos. AP: Crepitantes en bases. EEII: Edemas con fóvea."></textarea></div>
                        <div class="pattern-group"><label for="planta-pruebas">Resultados de Pruebas Complementarias</label><textarea id="planta-pruebas" placeholder="Ej: Analítica: Leucocitos normales, PCR 45, Pro-BNP elevado. Rx Tórax: Signos de congestión pulmonar."></textarea></div>
                    </fieldset>
                </details>
                <details>
                    <summary>Plan de Actuación</summary>
                    <fieldset>
                        <div class="pattern-group"><label for="planta-tratamiento">Plan de Tratamiento Inicial</label><textarea id="planta-tratamiento" placeholder="Ej: Se inicia tratamiento con diuréticos IV (Furosemida), oxigenoterapia."></textarea></div>
                        <div class="pattern-group"><label for="planta-cuidados">Plan de Cuidados de Enfermería</label><textarea id="planta-cuidados" placeholder="Ej: Monitorización de constantes cada 8h, control de diuresis y balance hídrico, dieta hiposódica."></textarea></div>
                        <div class="pattern-group"><label for="planta-intervenciones">Justificación de Intervenciones</label><textarea id="planta-intervenciones" placeholder="Ej: Se canaliza VVP para sueroterapia. Profilaxis tromboembólica con heparina."></textarea></div>
                    </fieldset>
                </details>
            </div>

            <div id="evolutivo-fields" class="hidden">
                <details open>
                    <summary>Nota de Evolutivo (Formato SOAP)</summary>
                    <fieldset>
                        <div><label for="evo-fecha-hora">Fecha y Hora</label><input type="datetime-local" id="evo-fecha-hora"></div>
                        
                        <div class="pattern-group">
                            <label for="evo-subjetivo-objetivo">S/O - Datos Subjetivos y Objetivos</label>
                            <textarea id="evo-subjetivo-objetivo" placeholder="Síntomas referidos por el paciente, constantes vitales, resultados de pruebas, hallazgos de la exploración..."></textarea>
                        </div>

                        <div class="pattern-group">
                            <label for="evo-analisis">A - Análisis de la Evolución</label>
                            <textarea id="evo-analisis" placeholder="Interpretación de los datos anteriores. Ej: Paciente con evolución favorable, mejoría de la disnea, afebril..."></textarea>
                        </div>

                        <div class="pattern-group">
                            <label for="evo-plan">P - Plan a Seguir</label>
                            <textarea id="evo-plan" placeholder="Mantener misma pauta, pendiente de resultados, revalorar por la mañana..."></textarea>
                        </div>
                    </fieldset>
                </details>
            </div>
            <button type="button" id="generate-btn">
                <span id="spinner" class="spinner hidden"></span>
                <span id="btn-text">Generar Texto</span>
            </button>

            <div class="result-container">
                <div class="result-header">
                    <h2>Nota de Evolución</h2>
                    <button type="button" id="copy-report-btn" class="utility-btn">Copiar Evolución</button>
                </div>
                <textarea id="result-text" placeholder="Aquí aparecerá el informe principal..."></textarea>
                
                <div class="export-section">
                    <button type="button" id="export-pdf-btn" class="utility-btn">Exportar a PDF</button>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                    <button type="button" id="clear-btn" class="utility-btn">Limpiar Formulario</button>
               </div>
        </form>
    </div>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="/app.js"></script>
</body>
</html>
```eof
```javascript:api/generate.js
import fetch from 'node-fetch';

export default async (req, res) => {
  try {
    const { incomingData } = req.body;

    // --- INICIO: CAPA DE SEGURIDAD ---
    if (!incomingData || typeof incomingData !== 'object') {
      return res.status(400).json({ error: "Datos de entrada inválidos o ausentes." });
    }
    const { contexto } = incomingData;
    // Ahora 'evolutivo' es el único contexto que genera un informe simplificado
    const contextosValidos = ['urgencias', 'planta', 'evolutivo'];
    if (!contexto || !contextosValidos.includes(contexto)) {
      return res.status(400).json({ error: `Contexto inválido. Debe ser uno de: ${contextosValidos.join(', ')}` });
    }
    // --- FIN: CAPA DE SEGURIDAD ---

    const apiKey = process.env.GOOGLE_API_KEY;
    if (!apiKey) {
      throw new Error("La variable de entorno GOOGLE_API_KEY no está configurada.");
    }

    let masterPrompt;
    
    // --- INICIO: REGLAS DE IA (MODIFICADAS) ---
    const reglaDeOro = `
NO INVENTES NINGÚN DATO CLÍNICO NI ESPECULES. 
Si un campo de entrada está vacío, simplemente OMÍTELO en el informe final. 
Es preferible un informe corto y preciso que uno largo e inventado.
`;

    const reglaDeEstilo = `
REGLAS DE ESTILO Y TONO:
1.  LENGUAJE PROFESIONAL: redacta el informe en estilo narrativo y fluido, como un médico experimentado. 
2.  EFICIENCIA: usa abreviaturas médicas comunes cuando corresponda (ej: BEG, ACR, tto, AP, IQ).
3.  OBJETIVIDAD: limita el informe estrictamente a la información proporcionada.
4.  FORMATO LIMPIO: no uses formato Markdown ni símbolos especiales. Solo texto plano.
`;

    // --- Esta regla ahora es mucho más simple ---
    const reglaDeFormatoSimple = `
INSTRUCCIÓN FINAL:
Debes generar un único bloque de texto que sea el informe principal.
No incluyas separadores ni palabras clave. Solo el informe.
`;
    // --- FIN: REGLAS DE IA ---

    switch (contexto) {
      // Los casos 'urgencias' y 'planta' siguen funcionando como antes, con los 3 bloques de texto
      case 'urgencias':
        // (código de urgencias sin cambios...)
        const reglaDeFormatoCompleja = `
INSTRUCCIÓN FINAL:
Debes generar SIEMPRE 3 bloques de texto separados:
1. Informe principal.
2. Recomendaciones y plan a seguir.
3. Una lista de 5 a 7 palabras clave.
Separa el informe principal de las recomendaciones con:
---SEPARADOR---
Después de las recomendaciones, añade otra línea que contenga:
---KEYWORDS---
`;
        masterPrompt = `
Actúa como un médico de urgencias senior. 
Transforma las siguientes notas en un informe narrativo y profesional en español.
${reglaDeOro}
${reglaDeEstilo}
${reglaDeFormatoCompleja}
Datos para el informe de URGENCIAS:
---
${JSON.stringify(incomingData, null, 2)}
---`;
        break;

      case 'planta':
        // (código de planta sin cambios...)
        const reglaDeFormatoComplejaPlanta = `
INSTRUCCIÓN FINAL:
Debes generar SIEMPRE 3 bloques de texto separados:
1. Informe principal.
2. Recomendaciones y plan a seguir.
3. Una lista de 5 a 7 palabras clave.
Separa el informe principal de las recomendaciones con:
---SEPARADOR---
Después de las recomendaciones, añade otra línea que contenga:
---KEYWORDS---
`;
        masterPrompt = `
Actúa como un médico internista experimentado redactando un informe de ingreso en planta. 
Crea un documento completo y estructurado en español.
${reglaDeOro}
${reglaDeEstilo}
${reglaDeFormatoComplejaPlanta}
Datos para el informe de INGRESO EN PLANTA:
---
${JSON.stringify(incomingData, null, 2)}
---`;
        break;

      // --- INICIO: CASO EVOLUTIVO (AHORA SIMPLIFICADO) ---
      case 'evolutivo':
        const subjetivoObjetivo = incomingData['evo-subjetivo-objetivo'] || 'Sin datos.';
        const analisis = incomingData['evo-analisis'] || 'Sin datos.';
        const plan = incomingData['evo-plan'] || 'Sin datos.';

        masterPrompt = `
Actúa como un médico de planta que redacta una NOTA DE EVOLUCIÓN concisa y profesional.
Tu tarea es tomar los siguientes datos del formato SOAP y redactar un único párrafo narrativo, profesional y fluido en español que los integre.
${reglaDeOro}
${reglaDeEstilo}
${reglaDeFormatoSimple}

Datos para integrar:
S/O (Datos Subjetivos y Objetivos): ${subjetivoObjetivo}
A (Análisis de la Evolución): ${analisis}
P (Plan a Seguir): ${plan}
`;
        break;
      // --- FIN: CASO EVOLUTIVO ---

      default:
        masterPrompt = "Contexto no reconocido.";
    }

    const modelName = "gemini-1.5-pro-latest";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

    const generationConfig = { temperature: 0.2 };

    const requestBody = { 
      contents: [{ parts: [{ text: masterPrompt }] }],
      generationConfig
    };

    const googleResponse = await fetch(apiUrl, { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify(requestBody) 
    });

    if (!googleResponse.ok) {
      const errorData = await googleResponse.json();
      res.status(googleResponse.status).json({ error: `Error de la API de Google: ${googleResponse.statusText}`, details: errorData });
      return;
    }

    const data = await googleResponse.json();
    const fullText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";

    // --- INICIO: PARSING DE RESPUESTA (MODIFICADO) ---
    let reportPart, recommendationsPart, keywordsPart;

    if (contexto === 'evolutivo') {
        // Para el evolutivo, toda la respuesta es el informe.
        reportPart = fullText.trim() || "No se pudo generar el informe.";
        recommendationsPart = ""; // Vaciamos los otros campos
        keywordsPart = "";
    } else {
        // Para los otros contextos, mantenemos el parsing complejo
        const parts = fullText.split('---SEPARADOR---');
        reportPart = parts[0]?.trim() || "No se pudo generar el informe.";
        const recommendationsAndKeywords = parts[1] ? parts[1].split('---KEYWORDS---') : [];
        recommendationsPart = recommendationsAndKeywords[0]?.trim() || "";
        keywordsPart = recommendationsAndKeywords[1]?.trim() || "";
    }
    // --- FIN: PARSING DE RESPUESTA ---

    res.status(200).json({ 
      report: reportPart,
      recommendations: recommendationsPart,
      keywords: keywordsPart
    });

  } catch (error) {
    console.error("Error en la función del servidor:", error);
    res.status(500).json({ error: `Error interno en el servidor: ${error.message}` });
  }
};
```eof

### Próximos Pasos

1.  **Reemplaza el Código**: Copia el contenido de estos dos archivos en tus archivos locales `public/index.html` y `api/generate.js`.
2.  **Sube a GitHub**: Guarda los cambios y súbelos a GitHub (`git add .`, `git commit -m "Simplificación del evolutivo"`, `git push`).
3.  **Prueba**: Una vez desplegado en Vercel, prueba de nuevo la sección "Evolutivo de planta".

Este enfoque es mucho más directo y tiene una probabilidad de éxito mucho mayor. Al darle a la IA una sola tarea bien definida para el evolutivo, los resultados deberían ser consistentes y correctos.